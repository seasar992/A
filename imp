Sub WaveSpectra_WSOファイル取り込み()
    
    Dim filename As String, SeetName As String, Errcode As String
    
    Dim newBook As Workbook
    Dim i As Long, M As Long, N As Long, DataC As Long
    Dim moni1 As Single, moni2 As Single, moni3 As Single 'デバッグ用モニタ
    On Error GoTo Err1

Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual



Errcode = "000"

' WSのファイルをcsv変換してエクセルに読み込む
    
    filename = Application.GetOpenFilename("WaveSpectra ｵｰﾊﾞｰﾚｨﾌｧｲﾙ,*.WSO")
    If filename <> "False" Then
        NewName = Left(filename, Len(filename) - 4)
        NewName = NewName & ".CSV"
        SeetName = ExistFilename(NewName)
        If ExistBook(SeetName) Then Workbooks(SeetName).Close
        FileCopy filename, NewName
        Workbooks.Open NewName
    Else
        Exit Sub
    End If
    

' Amplitudeの配列に値を入れる

Errcode = "001"


Dim FFTpoint As Long: FFTpoint = Workbooks(SeetName).ActiveSheet.Cells(4, 2)
Dim SamplingFreq As Long: SamplingFreq = Workbooks(SeetName).ActiveSheet.Cells(3, 2)
Dim DataNumber As Long: DataNumber = Workbooks(SeetName).ActiveSheet.Cells(5, 2)
'Dim BlockLength As Integer: BlockLength = FFTpoint / SamplingFreq

Dim Amplitude(65536) As Single
Dim FrequencyInterval As Single

FrequencyInterval = SamplingFreq / FFTpoint

    M = Workbooks(SeetName).ActiveSheet.Cells(4, 2) / 16 + 6
    DataC = 1
    For N = 6 To M
    For i = 1 To 8
        Amplitude(DataC) = Workbooks(SeetName).ActiveSheet.Cells(N, i)
        DataC = DataC + 1
        If DataC = 65537 Then Exit For

    Next i
        If DataC = 65537 Then Exit For
    Next N



' 縦行の制限から65536ポイント以上のFFTはサポート外。

Errcode = "002"

ThisWorkbook.Activate

DataNumber = Application.WorksheetFunction.Min(DataNumber, 65536)
Range(Cells(1, 1), Cells(65536, 3)).ClearContents

Dim freq As Single, Value As Single, LogValue As Single

' 値を一列に書き出す Amplitudeはなぜか２倍しないと合わない

    For i = 1 To DataNumber
        freq = FrequencyInterval * (i - 1)
        Value = 2 * Amplitude(i)
        LogValue = 20 * Log(Value / 32768) / Log(10)
        Cells(i, 1) = freq
        Cells(i, 3) = Value
        Cells(i, 2) = LogValue
    Next i

    Workbooks(SeetName).Close
    
Application.Calculation = xlCalculationAutomatic
Application.Calculate
Application.ScreenUpdating = True


Exit Sub

Err1:
    MsgBox "ファイルインポートでエラーが発生しました。" & Chr(13) & "code= " & Errcode, vbExclamation
 '   MsgBox Str(freq) & " " & Str(Value) & " " & Str(LogValuee), vbExclamation
'    Workbooks(SeetName).Close



End Sub

Function ExistFilename(filepath) As String

    Dim PathName As String, filename As String, pos As Long
    
    pos = InStrRev(filepath, "\")
    'PathName = Left(filepath, pos)
    ExistFilename = Mid(filepath, pos + 1)

End Function



Function ExistBook(BookName) As Boolean
    '引数 BookName のブックが実際にあるかチェックする
    
    Dim i As Integer, cnt As Integer
    
    cnt = Workbooks.Count
    ExistBook = False
    For i = 1 To cnt
        If Workbooks(i).Name = BookName Then
            ExistBook = True
            Exit For
        End If
    Next
End Function


